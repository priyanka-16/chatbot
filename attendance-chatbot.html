<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attendance Chatbot</title>
  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
</head>

<body>
  <df-messenger
    intent="WELCOME"
    chat-title="Attendance-chatbot"
    agent-id="80b0458e-6086-4f3e-a7af-f12665e5f385"
    language-code="en"
  ></df-messenger>

  <script>
    const dfMessenger = document.querySelector('df-messenger');
    dfMessenger.addEventListener('df-response-received', function(event) {
      const messages = event.detail.response.queryResult.fulfillmentMessages;

      // Check each fulfillment message for payload
      for (const msg of messages) {
        if (msg.payload && msg.payload.fields) {
          // ✅ Extract your attendance data
          const fields = msg.payload.fields.attendance_data.structValue.fields;

          const studentName = fields.student_name.listValue.values.map(v => v.stringValue);
          const rollNumber = fields.roll_number.listValue.values.map(v => v.numberValue);
          const status = fields.status.stringValue;

          const attendanceData = {
            student_name: studentName,
            roll_number: rollNumber,
            status: status
          };

          console.log('✅ Attendance Data:', attendanceData);

          // ✅ Post to Flutter
          if (window.AttendanceChannel) {
            AttendanceChannel.postMessage(JSON.stringify(attendanceData));
          }
        }
      }
    });
  </script>
</body>
</html>
